<!-- index.html – versão “tablet sobre madeira” -->
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OMOM SPA</title>

  <!-- fonte pixel‑art -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

  <style>
    /* ===== RESET BÁSICO ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;color:#fff;font-family:'Courier New',monospace;background:none}

    /* ===== PALCO COM MADEIRA DE FUNDO ===== */
    #app{                /* continua usando o id já referenciado no JS */
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      background:url(fundo.png) center/cover no-repeat fixed;   /* fundo madeira */
    }

    /* ===== “TABLET” ===== */
    :root{
      --tablet-max:640px;   /* largura máxima do aparelho */
      --tablet-ratio:1/1;   /* aspecto 3:4 (portrait)      */
    }

    .tablet{
      position:relative;
      width:min(90vw,var(--tablet-max));
      aspect-ratio:var(--tablet-ratio);
      margin:clamp(1rem,5vmin,3rem) auto 0;
      filter:drop-shadow(0 10px 15px #0080);
      perspective:1200px;
    }

    /* moldura preta fosca */
    .tablet>.bezel{
      position:absolute;inset:0;border-radius:2.2rem;background:#111;pointer-events:none
    }

    /* área de cena (canvas + vídeo) */
    #globe-area{
      position:absolute;inset:4%;border-radius:1.4rem;overflow:hidden;z-index:0
    }
    #globeCanvas{width:100%;height:100%;object-fit:contain;background:#000}

    /* painéis/overlay dentro da tela */
    #ui-layer{
      position:absolute;inset:4%;border-radius:1.4rem;z-index:1;pointer-events:none
    }
    #painel{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}

    /* botão MENU (agora dentro da ui‑layer) */
    #btnMenu{
      position:absolute;top:1rem;left:1rem;
      background:rgba(0,0,0,.7);border:2px solid #00FFE7;
      color:#00FFE7;font-family:'Press Start 2P',cursive;
      font-size:8px;padding:10px;cursor:pointer;pointer-events:auto
    }
    #btnMenu:hover{background:rgba(0,0,0,.9)}

    /* vídeo introdutório (acima do canvas, ainda dentro de globe-area) */
    #intro-video{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:40%;height:auto;pointer-events:none;display:none;z-index:2
    }

    /* ===== FLIPBOOK ===== */
    #flipbook-area{
      width:100%;max-width:var(--tablet-max);
      margin:0 auto;padding-top:2vh;overflow:hidden;
      height:0;transition:height .8s ease; /* fechado por padrão */
    }
    #flipbook-area.open{height:80vh}        /* classe usada no JS para abrir */

    #flipbookContainer{width:100%;height:100%}

    /* seta do flipbook */
    #setaBtn{
      position:absolute;top:10px;right:10px;width:35px;height:auto;
      cursor:pointer;opacity:0;animation:fadeInArrow .6s forwards .4s,slideArrow 1s ease-in-out infinite .4s;z-index:5
    }
    @keyframes fadeInArrow{from{opacity:0}to{opacity:1}}
    @keyframes slideArrow{0%{transform:translate(0)}50%{transform:translate(-8px,8px)}100%{transform:translate(0)}}

    /* ========== MENUS / ÍCONES ========== */
    #menu-overlay{
      position:absolute;inset:0;backdrop-filter:blur(6px);
      display:none;z-index:3
    }
    #menu-overlay.visible{display:block}

    .symbols-wrapper{position:absolute;top:40px;left:0;right:0;bottom:0;overflow-y:auto;padding:20px}
    .symbols-container{display:flex;flex-wrap:wrap;justify-content:center;gap:25px}
    @keyframes floatWave{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    .symbol{cursor:pointer;animation:floatWave 4s ease-in-out infinite}
    .symbol img{width:18vw;transition:transform .3s}
    .symbol img:hover{transform:scale(1.1)}
    .symbol.brither img{filter:brightness(180%)}
    .symbol.locked img{filter:brightness(50%)}

    /* ========== OVERLAY DE IMAGEM ========== */
    #overlayContainer{
      position:fixed;inset:0;background:rgba(0,0,0,.8);
      display:none;justify-content:center;align-items:center;z-index:1000
    }
    #overlayImage{max-width:80%;max-height:80%;transition:transform .3s}
    #btnSair{
      position:absolute;top:20px;right:20px;
      background:rgba(0,0,0,.7);border:2px solid #00FFE7;color:#00FFE7;
      font-family:'Press Start 2P',cursive;font-size:12px;padding:10px;cursor:pointer
    }

    /* ========== TELA DE CARREGAMENTO & SOM ========== */
    #loading-screen{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000;z-index:9999
    }
    #loading-text{font-family:'Press Start 2P',cursive;color:#00FFE7;font-size:20px}

    #soundPrompt{
      position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;
      background:#000;z-index:10000
    }
    #soundPrompt p{font-family:'Press Start 2P',cursive;color:#00FFE7;font-size:24px;margin-bottom:30px;text-align:center}
    .soundBtn{
      background:none;border:2px solid #00FFE7;color:#00FFE7;
      font-family:'Press Start 2P',cursive;font-size:14px;padding:12px 22px;
      cursor:pointer;transition:background .25s
    }
    .soundBtn:hover{background:#00FFE733}
  </style>
</head>

<body>
  <!-- áudio -->
  <audio id="bgm" src="animus.mp3" preload="auto" loop></audio>
  <audio id="memories" src="memories.mp3" preload="auto" loop></audio>

  <!-- prompt som -->
  <div id="soundPrompt">
    <p>SOM?</p>
    <div class="btnWrap">
      <button class="soundBtn" id="btnYes">SIM</button>
      <button class="soundBtn" id="btnNo">NÃO</button>
    </div>
  </div>

  <!-- palco principal -->
  <div id="app">
    <!-- TABLET -->
    <section class="tablet">
      <div class="bezel"></div>

      <div id="globe-area">
        <canvas id="globeCanvas"></canvas>
        <video id="intro-video" src="omom.mp4" muted playsinline></video>
      </div>

      <!-- camada de UI -->
      <div id="ui-layer">
        <img id="painel" src="painel.png" alt="Painel">
        <button id="btnMenu">MENU</button>
      </div>

      <!-- menu rolante -->
      <div id="menu-overlay">
        <div class="symbols-wrapper">
          <div class="symbols-container">
            <div class="symbol brither" data-world="veleywei"><img src="assets/veleyweimenu.png" alt="Velei'wey"></div>
            <div class="symbol locked" data-world="botychera"><img src="mundos/botychera/botycheramenu.png" alt="Botychera"></div>
            <div class="symbol locked" data-world="himpis"><img src="mundos/himpis/himpismenu.png" alt="Himpis"></div>
            <div class="symbol brither" data-world="batedores"><img src="mundos/ttok/ttokmenu.png" alt="Batedores"></div>
            <div class="symbol locked" data-world="denbou"><img src="mundos/denbou/denboumenu.png" alt="DenBou"></div>
            <div class="symbol locked" data-world="araporu"><img src="mundos/araporu/araporumenu.png" alt="Araporu"></div>
            <div class="symbol locked" data-world="artesaos"><img src="mundos/os artesaos/artesaosmenu.png" alt="Artesãos"></div>
            <div class="symbol locked" data-world="sapador"><img src="mundos/sapador/sapador.png" alt="Sapador"></div>
            <div class="symbol locked" data-world="dosirelala"><img src="mundos/dosirelala/dosirelalamenu.png" alt="Dosirelala"></div>
            <div class="symbol locked" data-world="calindreno"><img src="mundos/calindreno/calindreno.png" alt="Calindreno"></div>
            <div class="symbol locked" data-world="mundoPulsante"><img src="mundos/mundo pulsante/jocelyn.png" alt="Mundo Pulsante"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FLIPBOOK -->
    <section id="flipbook-area">
      <div id="flipbookContainer"></div>
    </section>
  </div>

  <!-- overlay imagem -->
  <div id="overlayContainer">
    <button id="btnSair">FECHAR</button>
    <img id="overlayImage" src="" alt="Zoom">
  </div>

  <!-- loading -->
  <div id="loading-screen"><div id="loading-text">CARREGANDO…</div></div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="turn.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

  <script>
    /* -------- FADE DE ÁUDIO -------- */
    function fadeIn(a,ms){a.volume=0;a.play().catch(()=>{});const s=50,dv=s/ms;const id=setInterval(()=>{if(a.volume+dv>=1){a.volume=1;clearInterval(id)}else a.volume+=dv},s)}
    function fadeOut(a,ms){const s=50,dv=s/ms;const id=setInterval(()=>{if(a.volume-dv<=0){a.volume=0;clearInterval(id);a.pause();a.currentTime=0}else a.volume-=dv},s)}

    let allowSound=false;

    /* -------- SETUP INICIAL -------- */
    window.addEventListener('load',()=>{
      document.getElementById('loading-screen').style.display='none';
      document.getElementById('soundPrompt').style.display='flex';
    });

    function startSite(sound){
      allowSound=sound;
      document.getElementById('soundPrompt').style.display='none';

      const intro=document.getElementById('intro-video');
      intro.style.display='block';
      intro.play().catch(()=>{});
      if(allowSound) document.getElementById('bgm').play().catch(()=>{});

      intro.addEventListener('ended',()=>{
        intro.style.display='none';
        showOverlayMenu();
      });
    }
    document.getElementById('btnYes').onclick=()=>startSite(true);
    document.getElementById('btnNo').onclick =()=>startSite(false);

    /* -------- MENU E MUNDOS -------- */
    const memories=document.getElementById('memories');
    function showOverlayMenu(){
      const ov=document.getElementById('menu-overlay');
      ov.classList.add('visible');
      if(allowSound) fadeIn(memories,1000);
    }
    document.querySelector('.symbols-container').addEventListener('click',e=>{
      const sym=e.target.closest('.symbol');if(!sym)return;launchWorld(sym.dataset.world);
    });
    document.getElementById('btnMenu').onclick=showOverlayMenu;

    function launchWorld(name){
      const fb=document.getElementById('flipbook-area');
      fb.classList.remove('open');          /* fecha flipbook antes de trocar */
      loadWorld(name);
    }

    function loadWorld(worldName){
      if(allowSound) fadeOut(memories,1000);

      destroyGlobe();

      document.getElementById('menu-overlay').classList.remove('visible');

      document.getElementById('flipbookContainer').innerHTML='';
      const s=document.createElement('script');
      s.src=worldName+'.js';
      document.body.appendChild(s);
      s.onload=()=>{
        window.initGlobe?.('#globeCanvas');
        window.initFlipbook?.('#flipbookContainer');
        document.getElementById('flipbook-area').classList.add('open');
      };
    }

    /* -------- DESTRÓI GLOBO -------- */
    function destroyGlobe(){
      const G=window._Globe;
      if(G){
        if(G.scene){
          G.scene.traverse(o=>{
            o.geometry?.dispose();
            if(o.material) (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m.dispose());
          });
          G.scene=null;
        }
        if(G.renderer){
          G.renderer.dispose();G.renderer.forceContextLoss?.();
          G.renderer.domElement?.parentNode?.removeChild(G.renderer.domElement);
          G.renderer=null;
        }
        G.controls?.dispose();G.controls=null;
      }
      const area=document.getElementById('globe-area');
      area.querySelector('canvas')?.remove();
      const c=document.createElement('canvas');c.id='globeCanvas';area.prepend(c);
    }

    /* -------- OVERLAY IMAGEM -------- */
    document.getElementById('btnSair').onclick=e=>{e.preventDefault();$('#overlayContainer').fadeOut(300)};
    document.getElementById('overlayContainer').onclick=e=>{if(e.target===e.currentTarget)$('#overlayContainer').fadeOut(300)};
  </script>
</body>
</html>
