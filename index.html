<script>
  // Adicionar isso no final do script existente
  let currentAudio = null;
  let musicEnabled = false;

  // Configuração do SPA
  const mainContent = document.createElement('div');
  mainContent.id = 'spa-content';
  document.body.appendChild(mainContent);

  // Novo loading screen estilizado
  const spaLoading = document.createElement('div');
  spaLoading.id = 'spa-loading';
  spaLoading.innerHTML = `
    <div class="warp-effect">
      <div class="star"></div>
      <div class="star"></div>
      <div class="star"></div>
    </div>
  `;
  document.body.appendChild(spaLoading);

  // Estilos adicionais para o SPA
  const style = document.createElement('style');
  style.textContent = `
    #spa-content {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }
    
    #spa-content.active {
      opacity: 1;
      pointer-events: all;
    }
    
    #spa-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    
    .warp-effect {
      position: relative;
      width: 200px;
      height: 200px;
    }
    
    .star {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #00FFE7;
      border-radius: 50%;
      animation: warp 1.5s infinite linear;
    }
    
    @keyframes warp {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(5); opacity: 0; }
    }
    
    .star:nth-child(2) { animation-delay: 0.5s; }
    .star:nth-child(3) { animation-delay: 1s; }
  `;
  document.head.appendChild(style);

  // Função para carregar conteúdo
  async function loadContent(url) {
    // Mostrar loading
    spaLoading.style.display = 'flex';
    
    // Fade out da música atual
    if(currentAudio && !currentAudio.paused) {
      fadeOutAudio(currentAudio, 1000);
    }

    // Carregar novo conteúdo
    const response = await fetch(url);
    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    
    // Extrair conteúdo principal
    const newContent = doc.querySelector('body').innerHTML;
    
    // Delay para efeito visual
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Esconder loading
    spaLoading.style.display = 'none';
    
    // Atualizar DOM
    mainContent.innerHTML = newContent;
    mainContent.classList.add('active');
    
    // Esconder elementos originais
    document.querySelector('.title-container').style.display = 'none';
    document.querySelector('.symbols-wrapper').style.display = 'none';
    
    // Iniciar nova música
    if(musicEnabled) {
      const newAudio = mainContent.querySelector('#bgm') || document.createElement('audio');
      newAudio.src = 'byfire.mp3';
      newAudio.volume = 0;
      newAudio.play();
      fadeInAudio(newAudio, 1000);
      currentAudio = newAudio;
    }
  }

  // Função para voltar ao menu
  function returnToMenu() {
    // Fade out conteúdo atual
    mainContent.classList.remove('active');
    
    // Restaurar elementos originais
    document.querySelector('.title-container').style.display = 'block';
    document.querySelector('.symbols-wrapper').style.display = 'block';
    
    // Fade in música original
    if(musicEnabled) {
      const mainAudio = document.getElementById('bgm');
      mainAudio.volume = 0;
      mainAudio.play();
      fadeInAudio(mainAudio, 1000);
      currentAudio = mainAudio;
    }
  }

  // Funções de áudio
  function fadeInAudio(audio, duration) {
    audio.volume = 0;
    const fadeInterval = 50;
    const volumeStep = 0.5 / (duration / fadeInterval);
    
    const fadeIn = setInterval(() => {
      if(audio.volume < 0.5) {
        audio.volume += volumeStep;
      } else {
        clearInterval(fadeIn);
      }
    }, fadeInterval);
  }

  // Modificar os event listeners dos símbolos
  document.querySelectorAll('.symbol a').forEach(link => {
    link.addEventListener('click', async (e) => {
      e.preventDefault();
      history.pushState(null, null, e.target.href);
      await loadContent(e.target.href);
    });
  });

  // Configurar botão de voltar
  window.addEventListener('popstate', () => {
    if(mainContent.classList.contains('active')) {
      returnToMenu();
    }
  });

  // Inicializar estado da música
  document.getElementById('yesBtn').addEventListener('click', () => {
    musicEnabled = true;
  });

  document.getElementById('noBtn').addEventListener('click', () => {
    musicEnabled = false;
  });
</script>
