<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#000000" />
  <title>OMOM SPA</title>

  <!-- fonte pixel-art -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

  <style>
    /* ===== RESET ===== */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      width:100%; height:100%; overflow:hidden; 
      background:#000; color:#fff; 
      font-family:'Courier New',monospace;
      /* Force fullscreen on mobile */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    /* Força altura completa considerando viewport mobile */
    html {
      height: 100vh;
      height: 100dvh; /* dynamic viewport height */
    }

    body {
      height: 100vh;
      height: 100dvh;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }

    /* ===== CONTAINER PRINCIPAL ===== */
    #app {
      width:100%; height:100%;
      position: relative;
      background: #000;
    }

    /* ===== TELA INICIAL OMOM ===== */
    #omom-screen {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    #omom-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 48px;
      color: white;
      opacity: 0;
      animation: fadeInTitle 2s ease-in-out forwards;
    }

    @keyframes fadeInTitle {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ===== MENU DE SÍMBOLOS ===== */
    #menu-overlay {
      position: fixed;
      inset: 0;
      background: url(fundo.webp) center/cover no-repeat;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #menu-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
    }

    #menu-overlay.visible { 
      display: flex; 
    }

    .symbols-wrapper { 
      position: relative;
      max-width: 90vw;
      max-height: 80vh;
      padding: 20px;
      overflow-y: auto;
      z-index: 1;
    }

    .symbols-container {
      display: flex; 
      flex-wrap: wrap;
      justify-content: center; 
      gap: 25px;
    }

    @keyframes floatWave {
      0%{transform:translateY(0)}
      50%{transform:translateY(-4px)}
      100%{transform:translateY(0)}
    }

    .symbol { 
      cursor: pointer; 
      animation: floatWave 4s ease-in-out infinite; 
    }

    .symbol img {
      width: 18vw; 
      max-width: 120px;
      transition: transform .3s;
    }

    .symbol img:hover { 
      transform: scale(1.1); 
    }

    .symbol.brither img { 
      filter: brightness(180%); 
    }

    .symbol.locked img  { 
      filter: brightness(50%); 
    }

    /* ===== FLIPBOOK AREA ===== */
    #flipbook-area {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 1.5s ease-out;
    }

    #flipbook-area.show { 
      transform: translateY(0); 
    }

    #flipbook-area.slide-out-down { 
      transform: translateY(100%); 
    }

    #flipbookContainer { 
      width: 95vh;
      height: 90vw;
      max-width: 600px;
      max-height: 800px;
      transform: rotate(90deg);
      transform-origin: center center;
    }

    /* ===== OVERLAY IMAGEM ===== */
    #overlayContainer {
      position: fixed; 
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none; 
      justify-content: center; 
      align-items: center;
      z-index: 10000;
    }

    #overlayImage { 
      max-width: 80%; 
      max-height: 80%; 
      transition: transform .3s; 
    }

    #btnSair {
      position: absolute; 
      top: 20px; 
      right: 20px;
      background: rgba(0,0,0,0.7); 
      border: 2px solid #00FFE7; 
      color: #00FFE7;
      font-family: 'Press Start 2P', cursive; 
      font-size: 12px; 
      padding: 10px;
      cursor: pointer;
    }

    /* ===== LOADING & SOM ===== */
    #loading-screen {
      position: fixed; 
      inset: 0;
      display: flex; 
      align-items: center; 
      justify-content: center;
      background: #000; 
      z-index: 99999;
    }

    #loading-text {
      font-family: 'Press Start 2P', cursive; 
      color: #00FFE7; 
      font-size: 20px;
    }

    #soundPrompt {
      position: fixed; 
      inset: 0;
      display: none; 
      flex-direction: column;
      align-items: center; 
      justify-content: center;
      background: #000; 
      z-index: 99998;
    }

    #soundPrompt p {
      font-family: 'Press Start 2P', cursive; 
      color: #00FFE7;
      font-size: 24px; 
      margin-bottom: 30px; 
      text-align: center;
    }

    .soundBtn {
      background: none; 
      border: 2px solid #00FFE7; 
      color: #00FFE7;
      font-family: 'Press Start 2P', cursive; 
      font-size: 14px; 
      padding: 12px 22px;
      cursor: pointer; 
      transition: background .25s;
      margin: 0 10px;
    }

    .soundBtn:hover { 
      background: rgba(0,255,231,0.2); 
    }

    /* ===== SETA DE VOLTAR ===== */
    #btnVoltar {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      border: 2px solid #00FFE7;
      color: #00FFE7;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      padding: 10px;
      cursor: pointer;
      z-index: 1001;
      display: none;
    }

    #btnVoltar:hover {
      background: rgba(0,0,0,0.9);
    }

    #btnVoltar.show {
      display: block;
    }

    /* ===== DESKTOP ===== */
    @media screen and (min-width: 1024px) {
      #app {
        background: url(fundodesktop.webp) center/cover no-repeat fixed;
      }

      #omom-title {
        font-size: 64px;
      }

      #menu-overlay {
        background: url(fundodesktop.webp) center/cover no-repeat;
      }

      #flipbookContainer {
        width: 80vw;
        height: 80vh;
        max-width: 1000px;
        max-height: 700px;
        transform: none;
      }

      .symbol img {
        width: 120px;
        max-width: 120px;
      }
    }

    /* ===== MOBILE LANDSCAPE (para o flipbook) ===== */
    @media screen and (max-width: 1023px) and (orientation: landscape) {
      #flipbookContainer {
        width: 95vw;
        height: 85vh;
        height: 85dvh; /* dynamic viewport height */
        transform: none;
      }
      
      /* Ajustes para fullscreen mobile landscape */
      #flipbook-area {
        height: 100vh;
        height: 100dvh;
      }
    }

    /* Ajustes específicos para navegadores mobile */
    @supports (-webkit-touch-callout: none) {
      /* iOS Safari */
      #flipbookContainer {
        height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
    }
  </style>
</head>

<body>
  <!-- áudio -->
  <audio id="bgm" src="animus.mp3" preload="auto" loop></audio>
  <audio id="memories" src="memories.mp3" preload="auto" loop></audio>

  <!-- loading -->
  <div id="loading-screen">
    <div id="loading-text">CARREGANDO…</div>
  </div>

  <!-- prompt som -->
  <div id="soundPrompt">
    <p>SOM?</p>
    <div class="btnWrap">
      <button class="soundBtn" id="btnYes">SIM</button>
      <button class="soundBtn" id="btnNo">NÃO</button>
    </div>
  </div>

  <!-- tela inicial OMOM -->
  <div id="omom-screen">
    <div id="omom-title">OMOM</div>
  </div>

  <!-- palco principal -->
  <div id="app">
    <!-- menu de símbolos -->
    <div id="menu-overlay">
      <div class="symbols-wrapper">
        <div class="symbols-container">
          <div class="symbol brither" data-world="veleywei">
            <img src="assets/veleyweimenu.png" alt="Velei'wey">
          </div>
          <div class="symbol locked" data-world="botychera">
            <img src="mundos/botychera/botycheramenu.png" alt="Botychera">
          </div>
          <div class="symbol locked" data-world="himpis">
            <img src="mundos/himpis/himpismenu.png" alt="Himpis">
          </div>
          <div class="symbol brither" data-world="batedores">
            <img src="mundos/ttok/ttokmenu.png" alt="Batedores">
          </div>
          <div class="symbol locked" data-world="denbou">
            <img src="mundos/denbou/denboumenu.png" alt="DenBou">
          </div>
          <div class="symbol locked" data-world="araporu">
            <img src="mundos/araporu/araporumenu.png" alt="Araporu">
          </div>
          <div class="symbol locked" data-world="porojka">
            <img src="mundos/os artesaos/artesaosmenu.png" alt="Artesãos">
          </div>
          <div class="symbol locked" data-world="sapador">
            <img src="mundos/sapador/sapador.png" alt="Sapador">
          </div>
          <div class="symbol locked" data-world="dosirelala">
            <img src="mundos/dosirelala/dosirelalamenu.png" alt="Dosirelala">
          </div>
          <div class="symbol locked" data-world="calindreno">
            <img src="mundos/calindreno/calindreno.png" alt="Calindreno">
          </div>
          <div class="symbol locked" data-world="mundoPulsante">
            <img src="mundos/mundo pulsante/jocelyn.png" alt="Mundo Pulsante">
          </div>
          <div class="symbol locked" data-world="sapador2">
            <img src="mundos/mundo 6/criaturamenu.webp" alt="Sapador 2">
          </div>
          <div class="symbol locked" data-world="dosirelala2">
            <img src="mundos/mundo 5/bratentacolonmenu.webp" alt="Dosirelala 2">
          </div>
        </div>
      </div>
    </div>

    <!-- área do flipbook -->
    <div id="flipbook-area">
      <button id="btnVoltar">VOLTAR</button>
      <div id="flipbookContainer"></div>
    </div>
  </div>

  <!-- overlay imagem -->
  <div id="overlayContainer">
    <button id="btnSair">FECHAR</button>
    <img id="overlayImage" src="" alt="Zoom">
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="turn.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

  <script>
    // ==== FADE AUDIO ====
    function fadeIn(a, ms) {
      a.volume = 0;
      a.play().catch(()=>{});
      const step = 50, dv = step/ms, id = setInterval(()=>{
        if (a.volume + dv >= 1) { a.volume = 1; clearInterval(id); }
        else a.volume += dv;
      }, step);
    }

    function fadeOut(a, ms) {
      const step = 50, dv = step/ms, id = setInterval(()=>{
        if (a.volume - dv <= 0) { a.volume = 0; clearInterval(id); a.pause(); a.currentTime = 0; }
        else a.volume -= dv;
      }, step);
    }

    let allowSound = false;

    // ==== BOOT SEQUENCE ====
    window.addEventListener('load', ()=>{
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('soundPrompt').style.display = 'flex';
      
      // Força fullscreen em mobile
      requestFullscreen();
    });

    // Função para tentar entrar em fullscreen
    function requestFullscreen() {
      const elem = document.documentElement;
      
      // Detecta se é mobile
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Tenta diferentes métodos de fullscreen
        if (elem.requestFullscreen) {
          elem.requestFullscreen().catch(() => {});
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen().catch(() => {});
        } else if (elem.mozRequestFullScreen) {
          elem.mozRequestFullScreen().catch(() => {});
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen().catch(() => {});
        }
        
        // Para iOS Safari - tenta esconder a barra de endereços
        setTimeout(() => {
          window.scrollTo(0, 1);
        }, 100);
      }
    }

    // Reaplica fullscreen quando necessário
    document.addEventListener('orientationchange', () => {
      setTimeout(() => {
        requestFullscreen();
        window.scrollTo(0, 1);
      }, 300);
    });

    // Previne zoom e outros gestos indesejados
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());

    function startSite(sound) {
      allowSound = sound;
      document.getElementById('soundPrompt').style.display = 'none';
      
      if (allowSound) {
        document.getElementById('bgm').play().catch(()=>{});
      }

      // Mostrar tela OMOM por 3 segundos, depois mostrar menu
      setTimeout(() => {
        document.getElementById('omom-screen').style.display = 'none';
        showMenu();
      }, 3000);
    }

    document.getElementById('btnYes').onclick = ()=>startSite(true);
    document.getElementById('btnNo').onclick = ()=>startSite(false);

    // ==== MENU ====
    const memories = document.getElementById('memories');

    function showMenu() {
      document.getElementById('menu-overlay').classList.add('visible');
      if (allowSound) {
        fadeOut(document.getElementById('bgm'), 500);
        setTimeout(() => fadeIn(memories, 1000), 500);
      }
    }

    function hideMenu() {
      document.getElementById('menu-overlay').classList.remove('visible');
      if (allowSound) {
        fadeOut(memories, 1000);
      }
    }

    // ==== SELEÇÃO DE MUNDO ====
    document.querySelector('.symbols-container').addEventListener('click', e=>{
      const sym = e.target.closest('.symbol');
      if (!sym) return;
      
      // Verificar se está desbloqueado
      if (sym.classList.contains('locked')) {
        return; // Não fazer nada se estiver bloqueado
      }
      
      launchWorld(sym.dataset.world);
    });

    function launchWorld(name) {
      // Esconder menu
      hideMenu();

      // Esconder flipbook se estiver visível
      const fb = document.getElementById('flipbook-area');
      if (fb.classList.contains('show')) {
        fb.classList.remove('show');
        fb.classList.add('slide-out-down');
        setTimeout(() => {
          fb.classList.remove('slide-out-down');
          loadWorld(name);
        }, 1500);
      } else {
        loadWorld(name);
      }
    }

    function loadWorld(name) {
      // Limpar container do flipbook
      document.getElementById('flipbookContainer').innerHTML = '';

      // Mostrar botão voltar
      document.getElementById('btnVoltar').classList.add('show');

      // Carregar script do mundo
      const s = document.createElement('script');
      s.src = name + '.js';
      document.body.appendChild(s);
      
      s.onload = () => {
        // Não inicializar globo (removido)
        window.initFlipbook?.('#flipbookContainer');
        
        // Mostrar flipbook
        const fb = document.getElementById('flipbook-area');
        void fb.offsetWidth; // Force reflow
        fb.classList.add('show');
      };
    }

    // ==== BOTÃO VOLTAR ====
    document.getElementById('btnVoltar').onclick = () => {
      const fb = document.getElementById('flipbook-area');
      fb.classList.remove('show');
      fb.classList.add('slide-out-down');
      
      document.getElementById('btnVoltar').classList.remove('show');
      
      setTimeout(() => {
        fb.classList.remove('slide-out-down');
        document.getElementById('flipbookContainer').innerHTML = '';
        showMenu();
      }, 1500);
    };

    // ==== OVERLAY IMAGEM ====
    document.getElementById('btnSair').onclick = e => {
      e.preventDefault();
      $('#overlayContainer').fadeOut(300);
    };

    document.getElementById('overlayContainer').onclick = e => {
      if (e.target === e.currentTarget) {
        $('#overlayContainer').fadeOut(300);
      }
    };

    // ==== FUNÇÃO GLOBAL PARA MOSTRAR IMAGEM ====
    window.showImageOverlay = function(src) {
      document.getElementById('overlayImage').src = src;
      $('#overlayContainer').fadeIn(300);
    };
  </script>
</body>
</html>
